# 架构文档

## 系统架构概述

Company Assistant Agent 采用模块化设计，主要组件包括：

1. **查询分类器** - 判断查询类型
2. **安全过滤器** - 检测有害内容
3. **知识库检索器** - RAG检索本地知识
4. **网络搜索器** - 搜索外部信息
5. **LLM客户端** - 与智谱AI GLM-4.7交互
6. **主助手** - 协调所有组件

## 数据流

```
用户查询
    ↓
安全过滤器检查
    ↓
查询分类器
    ↓
    ├─→ 公司内部 → 知识库检索 → RAG
    ├─→ 外部知识 → 网络搜索
    ├─→ 模糊查询 → 尝试两者或请求澄清
    └─→ 有害查询 → 拒绝
    ↓
LLM生成回答
    ↓
返回用户
```

## 核心模块说明

### 1. QueryClassifier (查询分类器)

基于关键词匹配的轻量级分类器，将查询分为：
- `COMPANY_INTERNAL`: 公司内部查询
- `EXTERNAL_KNOWLEDGE`: 外部知识查询
- `AMBIGUOUS`: 模糊查询
- `HARMFUL`: 有害查询

### 2. SafetyFilter (安全过滤器)

使用关键词列表检测：
- 有害内容
- 不当内容
- 违反公司政策的内容

### 3. KnowledgeRetriever (知识库检索器)

实现RAG（Retrieval-Augmented Generation）：
1. 将Markdown文件解析为文本块
2. 使用sentence-transformers生成嵌入
3. 存储在ChromaDB向量数据库
4. 基于语义相似度检索相关文档

### 4. WebSearcher (网络搜索器)

使用DuckDuckGo搜索API获取外部信息。

### 5. LLMClient (LLM客户端)

封装智谱AI GLM-4.7 API调用：
- 支持流式和非流式响应
- 构建系统提示词
- 管理对话上下文

### 6. Assistant (主助手)

协调所有组件：
- 处理查询路由
- 管理对话历史
- 生成最终响应

## 技术选型理由

### 智谱AI GLM-4.7
- 强大的中文理解能力
- 支持长上下文（200K tokens）
- 良好的代码生成能力
- 适合企业应用场景

### ChromaDB
- 轻量级，无需额外服务
- 支持持久化存储
- 易于集成和部署
- 适合中小规模知识库

### sentence-transformers
- 本地运行，无需API调用
- 成本低
- 支持中文语义理解
- all-MiniLM-L6-v2模型平衡了性能和速度

### Typer + Rich
- 现代化的CLI框架
- 美观的输出格式
- 良好的用户体验
- 易于扩展

## 设计决策

### 为什么使用RAG而不是微调？
- **灵活性**: 知识库更新无需重新训练
- **成本**: 避免微调的高成本
- **可解释性**: 可以追溯信息来源
- **快速迭代**: 易于添加新知识

### 为什么使用查询分类器？
- **成本优化**: 避免不必要的API调用
- **响应速度**: 快速路由到合适的数据源
- **准确性**: 针对不同查询类型优化策略

### 为什么选择ChromaDB而不是FAISS？
- **简单性**: 更易于使用和维护
- **持久化**: 内置持久化支持
- **元数据**: 支持丰富的元数据存储
- **足够性能**: 对于项目规模足够快

## 性能考虑

1. **向量数据库**: 使用ChromaDB的HNSW索引加速检索
2. **嵌入缓存**: sentence-transformers自动缓存模型
3. **对话历史**: 限制为最近20条消息，避免上下文过长
4. **流式输出**: 支持流式响应提升用户体验

## 扩展性

系统设计支持以下扩展：
- 添加新的知识库格式（PDF、Word等）
- 集成其他搜索API
- 支持多语言
- 添加更多安全过滤规则
- 实现用户认证和权限管理

## 安全性

1. **API密钥**: 通过环境变量管理，不提交到代码库
2. **安全过滤**: 多层过滤机制
3. **输入验证**: 所有用户输入都经过验证
4. **日志记录**: 记录关键操作（不含敏感信息）

## 未来改进方向

1. **更智能的分类**: 使用轻量级ML模型替代关键词匹配
2. **多模态支持**: 支持图像、文档等输入
3. **知识图谱**: 构建结构化知识图谱
4. **用户反馈**: 收集用户反馈改进系统
5. **A/B测试**: 测试不同的提示词和策略
