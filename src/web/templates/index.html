<!DOCTYPE html>
<html lang="zh-CN" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>小美 - ZURU Melon 智能客服</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Marked.js for markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Highlight.js for code syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            200: '#bfdbfe',
                            300: '#93c5fd',
                            400: '#60a5fa',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            800: '#1e40af',
                            900: '#1e3a8a',
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out',
                        'slide-up': 'slideUp 0.3s ease-out',
                        'pulse-dot': 'pulseDot 1.4s ease-in-out infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        pulseDot: {
                            '0%, 60%, 100%': { transform: 'translateY(0)' },
                            '30%': { transform: 'translateY(-4px)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #475569;
        }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }

        /* Code block styles */
        .code-block {
            position: relative;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        .code-block-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 1rem;
            background: #1e293b;
            border-bottom: 1px solid #334155;
        }
        .code-block pre {
            margin: 0;
            padding: 1rem;
            overflow-x: auto;
            background: #0f172a !important;
        }
        .code-block code {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875rem;
            line-height: 1.5;
        }

        /* Markdown content styles */
        .markdown-content p {
            margin-bottom: 0.75rem;
        }
        .markdown-content ul, .markdown-content ol {
            margin-left: 1.5rem;
            margin-bottom: 0.75rem;
        }
        .markdown-content li {
            margin-bottom: 0.25rem;
        }
        .markdown-content a {
            color: #3b82f6;
            text-decoration: underline;
        }
        .markdown-content a:hover {
            color: #2563eb;
        }
        .dark .markdown-content a {
            color: #60a5fa;
        }
        .dark .markdown-content a:hover {
            color: #93c5fd;
        }

        /* Typing indicator */
        .typing-indicator span {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #94a3b8;
            margin: 0 2px;
            animation: pulseDot 1.4s ease-in-out infinite;
        }
        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }
        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }
        .dark .typing-indicator span {
            background: #64748b;
        }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-900 min-h-screen flex items-center justify-center p-4 transition-colors duration-200">
    <div class="w-full max-w-4xl bg-white dark:bg-slate-800 rounded-2xl shadow-xl flex flex-col overflow-hidden max-h-[90vh]">
        <!-- Header -->
        <div class="bg-gradient-to-r from-primary-600 to-primary-700 text-white px-6 py-4 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <!-- Chat icon SVG -->
                <svg class="w-8 h-8" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                </svg>
                <div>
                    <h1 class="text-xl font-semibold">小美</h1>
                    <p class="text-sm text-primary-100">ZURU Melon 智能客服 - 为您服务</p>
                </div>
            </div>
            <!-- Dark mode toggle -->
            <button id="darkModeToggle" class="p-2 rounded-lg hover:bg-primary-500 transition-colors cursor-pointer" onclick="toggleDarkMode()" aria-label="Toggle dark mode">
                <!-- Sun icon -->
                <svg id="sunIcon" class="w-5 h-5 hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="5"></circle>
                    <line x1="12" y1="1" x2="12" y2="3"></line>
                    <line x1="12" y1="21" x2="12" y2="23"></line>
                    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                    <line x1="1" y1="12" x2="3" y2="12"></line>
                    <line x1="21" y1="12" x2="23" y2="12"></line>
                    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                </svg>
                <!-- Moon icon -->
                <svg id="moonIcon" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                </svg>
            </button>
        </div>

        <!-- Chat Container -->
        <div id="chatContainer" class="flex-1 overflow-y-auto custom-scrollbar p-4 bg-slate-50 dark:bg-slate-900">
            <!-- Empty State -->
            <div id="emptyState" class="flex flex-col items-center justify-center h-full text-slate-400 dark:text-slate-500">
                <svg class="w-16 h-16 mb-4 opacity-50" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                </svg>
                <p class="text-center max-w-md">开始对话吧！您可以询问公司政策、流程或一般知识问题。</p>
            </div>
        </div>

        <!-- Scroll to bottom button -->
        <button id="scrollToBottom" class="hidden absolute bottom-32 right-8 p-2 bg-primary-600 text-white rounded-full shadow-lg hover:bg-primary-700 transition-all cursor-pointer" onclick="scrollToBottom()">
            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
        </button>

        <!-- Input Container -->
        <div class="p-4 bg-white dark:bg-slate-800 border-t border-slate-200 dark:border-slate-700">
            <div class="flex gap-3">
                <input
                    type="text"
                    id="userInput"
                    placeholder="输入您的问题... (Enter 发送, Shift+Enter 换行)"
                    autocomplete="off"
                    class="flex-1 px-4 py-3 bg-slate-100 dark:bg-slate-700 border-2 border-transparent rounded-xl focus:border-primary-500 focus:outline-none focus:bg-white dark:focus:bg-slate-600 transition-all text-slate-800 dark:text-slate-100 placeholder-slate-400 dark:placeholder-slate-500"
                >
                <button
                    id="sendButton"
                    onclick="sendMessage()"
                    class="px-6 py-3 bg-primary-600 hover:bg-primary-700 disabled:bg-slate-300 dark:disabled:bg-slate-600 disabled:cursor-not-allowed text-white font-medium rounded-xl transition-all duration-200 cursor-pointer flex items-center gap-2"
                >
                    <span>发送</span>
                    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="22" y1="2" x2="11" y2="13"></line>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                    </svg>
                </button>
            </div>
            <!-- Controls -->
            <div class="flex gap-2 mt-3">
                <button onclick="clearHistory()" class="px-3 py-1.5 text-sm text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition-colors cursor-pointer flex items-center gap-1.5">
                    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M3 6h18"></path>
                        <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
                        <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
                    </svg>
                    清空历史
                </button>
                <button onclick="checkStatus()" class="px-3 py-1.5 text-sm text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition-colors cursor-pointer flex items-center gap-1.5">
                    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="12" y1="16" x2="12" y2="12"></line>
                        <line x1="12" y1="8" x2="12.01" y2="8"></line>
                    </svg>
                    系统状态
                </button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        let isLoading = false;

        // Initialize marked.js with highlight.js
        marked.setOptions({
            highlight: function(code, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    return hljs.highlight(code, { language: lang }).value;
                }
                return hljs.highlightAuto(code).value;
            },
            breaks: true,
            gfm: true
        });

        // Load dark mode preference
        function initDarkMode() {
            const isDark = localStorage.getItem('darkMode') === 'true';
            if (isDark) {
                document.documentElement.classList.add('dark');
                document.getElementById('sunIcon').classList.remove('hidden');
                document.getElementById('moonIcon').classList.add('hidden');
            }
        }

        function toggleDarkMode() {
            const html = document.documentElement;
            html.classList.toggle('dark');
            const isDark = html.classList.contains('dark');
            localStorage.setItem('darkMode', isDark);
            document.getElementById('sunIcon').classList.toggle('hidden', !isDark);
            document.getElementById('moonIcon').classList.toggle('hidden', isDark);
        }

        // Initialize dark mode on load
        initDarkMode();

        // Enter key to send, Shift+Enter for new line
        document.getElementById('userInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Show/hide scroll to bottom button
        document.getElementById('chatContainer').addEventListener('scroll', function() {
            const { scrollTop, scrollHeight, clientHeight } = this;
            const scrollBtn = document.getElementById('scrollToBottom');
            if (scrollHeight - scrollTop - clientHeight > 200) {
                scrollBtn.classList.remove('hidden');
            } else {
                scrollBtn.classList.add('hidden');
            }
        });

        function scrollToBottom() {
            const container = document.getElementById('chatContainer');
            container.scrollTo({
                top: container.scrollHeight,
                behavior: 'smooth'
            });
        }

        function formatTimestamp(date) {
            return date.toLocaleTimeString('zh-CN', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function copyToClipboard(text, buttonElement) {
            navigator.clipboard.writeText(text).then(() => {
                const originalIcon = buttonElement.innerHTML;
                buttonElement.innerHTML = `<svg class="w-4 h-4 text-green-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>`;
                setTimeout(() => {
                    buttonElement.innerHTML = originalIcon;
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy:', err);
            });
        }

        function renderCodeBlock(code, language) {
            const lang = language || 'text';
            return `
                <div class="code-block my-3">
                    <div class="code-block-header">
                        <span class="text-xs text-slate-400">${lang}</span>
                        <button class="text-slate-400 hover:text-white transition-colors cursor-pointer" onclick="copyToClipboard(\`${escapeHtml(code)}\`, this)">
                            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                            </svg>
                        </button>
                    </div>
                    <pre><code class="language-${lang}">${escapeHtml(code)}</code></pre>
                </div>
            `;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function renderMarkdown(text) {
            // Custom renderer for code blocks
            const renderer = new marked.Renderer();
            renderer.code = function(code, language) {
                return renderCodeBlock(code, language);
            };
            return marked.parse(text, { renderer });
        }

        function addMessage(content, isUser) {
            const container = document.getElementById('chatContainer');
            const emptyState = document.getElementById('emptyState');
            if (emptyState) {
                emptyState.remove();
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${isUser ? 'justify-end' : 'justify-start'} mb-4 animate-fade-in`;

            const timestamp = formatTimestamp(new Date());

            if (isUser) {
                messageDiv.innerHTML = `
                    <div class="max-w-[75%]">
                        <div class="bg-primary-600 text-white px-4 py-2.5 rounded-2xl rounded-br-md">
                            <p class="whitespace-pre-wrap">${escapeHtml(content)}</p>
                        </div>
                        <p class="text-xs text-slate-400 dark:text-slate-500 mt-1 text-right">${timestamp}</p>
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="max-w-[85%]">
                        <div class="bg-white dark:bg-slate-800 px-4 py-3 rounded-2xl rounded-bl-md border border-slate-200 dark:border-slate-700 shadow-sm">
                            <div class="markdown-content text-slate-700 dark:text-slate-200">${renderMarkdown(content)}</div>
                        </div>
                        <p class="text-xs text-slate-400 dark:text-slate-500 mt-1">${timestamp}</p>
                    </div>
                `;
            }

            container.appendChild(messageDiv);
            scrollToBottom();

            // Initialize syntax highlighting for new code blocks
            messageDiv.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
            });
        }

        function showLoading() {
            const container = document.getElementById('chatContainer');
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loadingMessage';
            loadingDiv.className = 'flex justify-start mb-4 animate-fade-in';
            loadingDiv.innerHTML = `
                <div class="bg-white dark:bg-slate-800 px-4 py-3 rounded-2xl rounded-bl-md border border-slate-200 dark:border-slate-700 shadow-sm">
                    <div class="typing-indicator flex gap-1">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            `;
            container.appendChild(loadingDiv);
            scrollToBottom();
        }

        function hideLoading() {
            const loading = document.getElementById('loadingMessage');
            if (loading) {
                loading.remove();
            }
        }

        async function sendMessage() {
            const input = document.getElementById('userInput');
            const query = input.value.trim();

            if (!query || isLoading) return;

            addMessage(query, true);
            input.value = '';
            isLoading = true;
            document.getElementById('sendButton').disabled = true;

            showLoading();

            try {
                const response = await fetch(`${API_BASE}/api/query`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        query: query,
                        use_history: true
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                hideLoading();
                addMessage(data.response, false);

            } catch (error) {
                hideLoading();
                const container = document.getElementById('chatContainer');
                const errorDiv = document.createElement('div');
                errorDiv.className = 'bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 text-red-700 dark:text-red-400 px-4 py-3 rounded-xl mb-4 animate-fade-in';
                errorDiv.innerHTML = `
                    <div class="flex items-start gap-2">
                        <svg class="w-5 h-5 flex-shrink-0 mt-0.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="8" x2="12" y2="12"></line>
                            <line x1="12" y1="16" x2="12.01" y2="16"></line>
                        </svg>
                        <div>
                            <p class="font-medium">发送失败</p>
                            <p class="text-sm">${escapeHtml(error.message)}</p>
                        </div>
                    </div>
                `;
                container.appendChild(errorDiv);
                scrollToBottom();
                console.error('Error:', error);
            } finally {
                isLoading = false;
                document.getElementById('sendButton').disabled = false;
                input.focus();
            }
        }

        async function clearHistory() {
            if (!confirm('确定要清空对话历史吗？')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/clear-history`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({})
                });

                if (response.ok) {
                    const container = document.getElementById('chatContainer');
                    container.innerHTML = `
                        <div id="emptyState" class="flex flex-col items-center justify-center h-full text-slate-400 dark:text-slate-500">
                            <svg class="w-16 h-16 mb-4 opacity-50" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                            </svg>
                            <p class="text-center max-w-md">对话历史已清空。开始新的对话吧！</p>
                        </div>
                    `;
                }
            } catch (error) {
                alert(`清空历史失败: ${error.message}`);
            }
        }

        async function checkStatus() {
            try {
                const response = await fetch(`${API_BASE}/api/status`);
                const data = await response.json();
                alert(data.message);
            } catch (error) {
                alert(`获取状态失败: ${error.message}`);
            }
        }
    </script>
</body>
</html>
